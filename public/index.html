<!doctype html>
<html data-theme="">
<head>
  <meta charset="utf-8" />
  <title>TextShare (Polling)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff; --fg:#111; --border:#ddd; --muted:#666; --tab:#f7f7f7;
    }
    :root[data-theme="dark"]{
      --bg:#0f1216; --fg:#e6e6e6; --border:#273042; --muted:#9aa4b2; --tab:#151a21;
    }
    @media (prefers-color-scheme: dark){
      :root:not([data-theme="light"]){
        --bg:#0f1216; --fg:#e6e6e6; --border:#273042; --muted:#9aa4b2; --tab:#151a21;
      }
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--fg); }
    .wrap { display: flex; flex-direction: column; height: 100%; }
    header { padding: 10px; border-bottom: 1px solid var(--border); display:flex; align-items:center; gap:12px; }
    .tabs { display:flex; gap:6px; flex-wrap: wrap; }
    .tab {
      padding:6px 10px; border:1px solid var(--border); border-bottom:none;
      border-radius:10px 10px 0 0; cursor:pointer; background:var(--tab); user-select:none;
    }
    .tab.active { background:var(--bg); font-weight:600; }
    .grow { flex:1 }
    .actions { display:flex; gap:8px; }
    button {
      padding:6px 10px; border:1px solid var(--border); border-radius:8px; background:transparent; color:var(--fg); cursor:pointer;
    }
    button:active { transform: translateY(1px); }
    textarea {
      flex: 1; width: 100%; resize: none; border: 0; outline: none; background: var(--bg); color: var(--fg);
      padding: 14px; font: 16px/1.4 monospace; box-sizing: border-box;
    }
    .pad-wrap { display:flex; flex-direction:column; height:100%; border-top:1px solid var(--border); }
    .hint { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <strong>TextShare</strong>
      <div class="tabs" id="tabs"></div>
      <div class="grow"></div>
      <div class="actions">
        <button id="themeBtn" title="Toggle dark mode">ðŸŒ“</button>
        <button id="addPadBtn" title="Add pad">+ Pad</button>
        <button id="renamePadBtn" title="Rename current pad">Rename</button>
        <button id="copyBtn" title="Copy current pad">Copy</button>
        <button id="clearBtn" title="Clear current pad">Clear</button>
      </div>
    </header>
    <div class="pad-wrap">
      <textarea id="pad" placeholder="Start typingâ€¦"></textarea>
      <div style="padding:6px 10px;">
        <span class="hint">Polling-based: updates every 1s. No login, no WebSockets.</span>
      </div>
    </div>
  </div>
  <script>
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('ts_theme');
    if (savedTheme) root.setAttribute('data-theme', savedTheme);
    document.getElementById('themeBtn').onclick = () => {
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem('ts_theme', next);
    };

    const padEl = document.getElementById('pad');
    const tabsEl = document.getElementById('tabs');
    const addPadBtn = document.getElementById('addPadBtn');
    const renamePadBtn = document.getElementById('renamePadBtn');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');

    let pads = {};
    let currentId = null;
    let polling = null;
    let quiet = false;

    function fetchPads(selectId = null) {
      fetch('/pads').then(res => res.json()).then(data => {
        pads = Object.fromEntries(data.map(p => [p.id, p]));
        renderTabs(selectId || currentId);
      });
    }

    function renderTabs(selectId) {
      tabsEl.innerHTML = '';
      Object.values(pads).forEach(p => {
        const t = document.createElement('div');
        t.className = 'tab' + (p.id === currentId ? ' active' : '');
        t.textContent = p.title;
        t.onclick = () => switchPad(p.id);
        t.ondblclick = () => renamePad(p.id);
        tabsEl.appendChild(t);
      });
      currentId = selectId || Object.keys(pads)[0];
      loadPad(currentId);
    }

    function switchPad(id) {
      if (!pads[id]) return;
      currentId = id;
      loadPad(id);
    }

    function loadPad(id) {
      stopPolling();
      fetch('/pad/' + id).then(res => res.json()).then(data => {
        padEl.value = data.text;
        startPolling(id);
      });
    }

    function startPolling(id) {
      polling = setInterval(() => {
        fetch('/pad/' + id).then(res => res.json()).then(data => {
          if (!quiet && data.text !== padEl.value) {
            quiet = true;
            const s = padEl.selectionStart, e = padEl.selectionEnd;
            padEl.value = data.text;
            padEl.setSelectionRange(s, e);
            quiet = false;
          }
        });
      }, 1000);
    }

    function stopPolling() {
      if (polling) clearInterval(polling);
    }

    padEl.addEventListener('input', () => {
      if (!quiet && currentId) {
        fetch('/pad/' + currentId, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: padEl.value })
        });
      }
    });

    addPadBtn.onclick = () => {
      const name = prompt("Pad name:", "Pad " + (Object.keys(pads).length + 1)) || "New Pad";
      fetch('/pad', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: name })
      }).then(res => res.json()).then(data => {
        fetchPads(data.id);
      });
    };

    function renamePad(id) {
      const name = prompt("New name:", pads[id]?.title || "") || "";
      fetch('/pad/' + id + '/rename', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: name })
      }).then(() => fetchPads());
    }

    renamePadBtn.onclick = () => currentId && renamePad(currentId);

    copyBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(padEl.value);
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy', 800);
      } catch {
        alert("Clipboard copy failed");
      }
    };

    clearBtn.onclick = () => {
      if (!currentId) return;
      if (confirm("Clear this pad for everyone?")) {
        fetch('/pad/' + currentId + '/clear', { method: 'POST' }).then(() => {
          padEl.value = "";
        });
      }
    };

    fetchPads();
  </script>
</body>
</html>
